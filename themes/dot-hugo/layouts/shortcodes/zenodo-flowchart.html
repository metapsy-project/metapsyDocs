<span id="ph-flowchart">
  <span id="spinner-ph-flowchart" class="loader-spinner"></span>
  <style>
  #spinner-ph-flowchart { width: 20px; height: 20px; margin-bottom: 10px; border: 2px solid rgb(133, 133, 133);
      border-bottom-color: transparent; border-radius: 50%; display: inline-block;
      box-sizing: border-box; animation: rotation 1s linear infinite;}
      @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}} 
  </style>
  <div id="flowchart-div">
    <center>
      <svg
        id="flow-svg"
        width="500"
        height="400"
        viewBox="0 0 500 400"
        style="max-width: 100%; max-height: 100%"
      ></svg>
    </center>
  </div>
</span>
<span id="flowchart-excluded-reasons-box">
  <button
    type="button"
    class="btn btn-default dropdown-toggle expand-btn"
    data-toggle="collapse"
    href="#collapseFlowchartExcludedReasons"
    role="button"
    aria-expanded="false"
  >
    Reasons for full-text exclusion<span class="caret"></span>
  </button>
  <div class="collapse" id="collapseFlowchartExcludedReasons">
    <div class="card card-body">
      <span id="ph-excluded-reasons"></span>
      <span id="spinner-ph-excluded-reasons" class="loader-spinner"></span>
      <style>
      #spinner-ph-excluded-reasons { width: 20px; height: 20px; margin-bottom: 10px; border: 2px solid rgb(133, 133, 133);
          border-bottom-color: transparent; border-radius: 50%; display: inline-block;
          box-sizing: border-box; animation: rotation 1s linear infinite;}
          @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}} 
      </style>
    </div>
  </div>
  <br />
</span>
<script>
  /* template for flow chart
  -------------------------- */
  var dataFlowChart = {
    nodes: [
      {
        id: "database-search",
        label: {
          name: "Records identified through database searches \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 240,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "gray",
        },
      },
      {
        id: "other-sources",
        label: {
          name: "Records identified through other sources \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 220,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "gray",
        },
      },
      {
        id: "duplicate",
        label: {
          name: "Records after duplicate removal \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 190,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "gray",
        },
      },
      {
        id: "screen",
        label: {
          name: "Records screened \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 150,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "gray",
        },
      },
      {
        id: "records-excluded",
        label: {
          name: "Records excluded \n ",
          color: "black",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 150,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "white",
          strokeColor: "gray",
        },
      },
      {
        id: "full-text",
        label: {
          name: "Full-text articles assessed for eligibility \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 210,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "#0372b7",
        },
      },
      {
        id: "included",
        label: {
          name: "Studies included in database \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 180,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#0372b7",
          strokeColor: "gray",
        },
      },
      {
        id: "excluded-full-text",
        label: {
          name: "Full-text excluded \n ",
          color: "black",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 150,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "white",
          strokeColor: "gray",
        },
      },
      {
        id: "included-dataset",
        label: {
          name: "Studies included in dataset \n ",
          color: "white",
          dx: 0,
          dy: 5,
          textAnchor: "middle",
          fontFamily: "sans-serif",
          fontSize: "10px",
        },
        style: {
          shape: "rect",
          width: 180,
          height: 40,
          rx: 3,
          ry: 3,
          fillColor: "#636363",
          strokeColor: "gray",
        },
      },
    ],
    map: [
      ["database-search", "other-sources"],
      ["duplicate", "drawIo"],
      ["screen", "records-excluded"],
      ["full-text", "excluded-full-text"],
      ["included"],
      ["included-dataset"],
    ],
    links: [
      {
        source: "database-search",
        target: "duplicate",
        style: { color: "gray" },
      },
      {
        source: "other-sources",
        target: "duplicate",
        style: { color: "gray" },
      },
      { source: "duplicate", target: "screen", style: { color: "gray" } },
      {
        source: "screen",
        target: "records-excluded",
        style: { color: "gray" },
      },
      { source: "screen", target: "full-text", style: { color: "gray" } },
      { source: "full-text", target: "included", style: { color: "gray" } },
      {
        source: "full-text",
        target: "excluded-full-text",
        style: { color: "gray" },
      },
      {
        source: "included",
        target: "included-dataset",
        style: { color: "gray" },
      },
    ],
  };

  /* Get metadata
  -------------------------- */
  // random id generator function
  function makeid(length) {
    var result = "";
    var characters =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }
  var randID = makeid(10);

  // get api response if not in sessions storage
  if (sessionStorage.getItem("apiResponse") === null) {
    async function fetchData() {
      let response = await fetch(
        "https://zenodo.org/api/deposit/depositions?" +
          "access_token=Bounk4ySHPIYxrFMWN49jyenJZ1Uy6tBhico7tuZ3iW6cp1hJ3m9FIY6HcvX" +
          "&all_versions=1&size=10000"
      );
      let data = await response.json();
      data = JSON.stringify(data);
      data = JSON.parse(data);
      return data;
    }
    async function saveApiResponse() {
      let data = await fetchData();
      sessionStorage.setItem("apiResponse", JSON.stringify(data));
      var post = data;

      // Run function code
      // loop through all elements
      var firstItem = true;
      for (let i = 0; i < post.length; i++) {
        var searchDOI = post[i].conceptdoi?.toString() || "";
        searchDOI = JSON.stringify(searchDOI);
        var inputDOI = JSON.stringify("{{.Get `doi`}}");

        // if DOI fits, do operation
        if (searchDOI === inputDOI) {
          if (firstItem === true) {
            var ghLink = post[i].metadata.related_identifiers[0].identifier;
            var repoName = ghLink.split("/")[4];
            var repoVersion = ghLink.split("/")[6];
            var readLink =
              "https://raw.githubusercontent.com/metapsy-project/" +
              repoName +
              "/" +
              repoVersion +
              "/metadata/" +
              "search_flow" +
              ".json";
            fetch(readLink)
              .then((d) => d.text())
              .then((d) => {
                d = JSON.parse(d);
                var databaseSearch = dataFlowChart.nodes.find(
                  (node) => node.id === "database-search"
                );
                var otherSources = dataFlowChart.nodes.find(
                  (node) => node.id === "other-sources"
                );
                var duplicate = dataFlowChart.nodes.find(
                  (node) => node.id === "duplicate"
                );
                var screen = dataFlowChart.nodes.find(
                  (node) => node.id === "screen"
                );
                var recordsExcluded = dataFlowChart.nodes.find(
                  (node) => node.id === "records-excluded"
                );
                var fullText = dataFlowChart.nodes.find(
                  (node) => node.id === "full-text"
                );
                var excludedFullText = dataFlowChart.nodes.find(
                  (node) => node.id === "excluded-full-text"
                );
                var included = dataFlowChart.nodes.find(
                  (node) => node.id === "included"
                );
                var includedDataset = dataFlowChart.nodes.find(
                  (node) => node.id === "included-dataset"
                );

                // database hits
                databaseSearch.label.name =
                  databaseSearch.label.name + "(n=" + d["database.hits"] + ")";
                // other sources
                otherSources.label.name =
                  otherSources.label.name +
                  "(n=" +
                  d["additional.records"] +
                  ")";
                // duplicates
                duplicate.label.name =
                  duplicate.label.name +
                  "(n=" +
                  d["database.hits.duplicates.removed"] +
                  ")";
                // screen
                screen.label.name =
                  screen.label.name + "(n=" + d["records.screened"] + ")";
                // excluded records
                noExcludedRecords =
                  d["records.screened"] -
                  d["full.text.assessed.for.eligibility"];
                recordsExcluded.label.name =
                  recordsExcluded.label.name + "(n=" + noExcludedRecords + ")";
                // full text
                fullText.label.name =
                  fullText.label.name +
                  "(n=" +
                  d["full.text.assessed.for.eligibility"] +
                  ")";
                // excluded full text
                noExcludedFullTextRecords =
                  d["full.text.assessed.for.eligibility"] - d["included"];
                excludedFullText.label.name =
                  excludedFullText.label.name +
                  "(n=" +
                  noExcludedFullTextRecords +
                  ")";
                // included
                included.label.name =
                  included.label.name + "(n=" + d["included"] + ")";

                var readLinkNrStudies =
                  "https://raw.githubusercontent.com/metapsy-project/" +
                  repoName +
                  "/" +
                  repoVersion +
                  "/metadata/" +
                  "number_studies" +
                  ".txt";
                fetch(readLinkNrStudies)
                  .then((nrStudies) => nrStudies.text())
                  .then((nrStudies) => {
                    // included in dataset
                    includedDataset.label.name =
                      includedDataset.label.name +
                      "(n=" +
                      String(JSON.parse(nrStudies)) +
                      ")";
                    // render flowchart
                    var flowcharty = new Flowcharty.default();
                    flowcharty.render(d3.select("#flow-svg"), dataFlowChart);
                  });

                // set random ID
                document.getElementById('spinner-ph-flowchart').style.display = 'none';
                var div = document.getElementById("ph-flowchart");
                div.id = div.id + "-" + randID;

                // write exlcuded reasons section
                var reasonsExcludedJSON = d["full.text.excluded.reasons"];
                var keys = Object.keys(reasonsExcludedJSON);
                var html =
                  " <div " +
                  "style='background-color: var(--body-color);" +
                  " padding: 20px 20px 20px 20px;" +
                  "overflow-y: scroll; height:300px;'><ul " +
                  "style='font-size: 90% !important;'>";
                for (let j = 0; j < keys.length; j++) {
                  var addHtml =
                    "<li><strong>" +
                    String(keys[j]) +
                    ":</strong> " +
                    String(reasonsExcludedJSON[keys[j]]) +
                    "</li>";
                  html = html + addHtml;
                }
                html = html + "</ul></div>";
                document.getElementById('spinner-ph-excluded-reasons').style.display = 'none';
                var div = document.getElementById("ph-excluded-reasons");
                div.id = "ph-excluded-reasons" + randID;
                div.innerHTML = html;
              });
            firstItem = false;
          }
        }
      }
    }
    saveApiResponse();
  } else {
    // Retrieve from session storage
    var post = JSON.parse(sessionStorage.getItem("apiResponse"));

    // Run function code
    // loop through all elements
    var firstItem = true;
    for (let i = 0; i < post.length; i++) {
      var searchDOI = post[i].conceptdoi?.toString() || "";
      searchDOI = JSON.stringify(searchDOI);
      var inputDOI = JSON.stringify("{{.Get `doi`}}");

      // if DOI fits, do operation
      if (searchDOI === inputDOI) {
        if (firstItem === true) {
          var ghLink = post[i].metadata.related_identifiers[0].identifier;
          var repoName = ghLink.split("/")[4];
          var repoVersion = ghLink.split("/")[6];
          var readLink =
            "https://raw.githubusercontent.com/metapsy-project/" +
            repoName +
            "/" +
            repoVersion +
            "/metadata/" +
            "search_flow" +
            ".json";
          fetch(readLink)
            .then((d) => d.text())
            .then((d) => {
              d = JSON.parse(d);
              var databaseSearch = dataFlowChart.nodes.find(
                (node) => node.id === "database-search"
              );
              var otherSources = dataFlowChart.nodes.find(
                (node) => node.id === "other-sources"
              );
              var duplicate = dataFlowChart.nodes.find(
                (node) => node.id === "duplicate"
              );
              var screen = dataFlowChart.nodes.find(
                (node) => node.id === "screen"
              );
              var recordsExcluded = dataFlowChart.nodes.find(
                (node) => node.id === "records-excluded"
              );
              var fullText = dataFlowChart.nodes.find(
                (node) => node.id === "full-text"
              );
              var excludedFullText = dataFlowChart.nodes.find(
                (node) => node.id === "excluded-full-text"
              );
              var included = dataFlowChart.nodes.find(
                (node) => node.id === "included"
              );
              var includedDataset = dataFlowChart.nodes.find(
                (node) => node.id === "included-dataset"
              );

              // database hits
              databaseSearch.label.name =
                databaseSearch.label.name + "(n=" + d["database.hits"] + ")";
              // other sources
              otherSources.label.name =
                otherSources.label.name + "(n=" + d["additional.records"] + ")";
              // duplicates
              duplicate.label.name =
                duplicate.label.name +
                "(n=" +
                d["database.hits.duplicates.removed"] +
                ")";
              // screen
              screen.label.name =
                screen.label.name + "(n=" + d["records.screened"] + ")";
              // excluded records
              noExcludedRecords =
                d["records.screened"] - d["full.text.assessed.for.eligibility"];
              recordsExcluded.label.name =
                recordsExcluded.label.name + "(n=" + noExcludedRecords + ")";
              // full text
              fullText.label.name =
                fullText.label.name +
                "(n=" +
                d["full.text.assessed.for.eligibility"] +
                ")";
              // excluded full text
              noExcludedFullTextRecords =
                d["full.text.assessed.for.eligibility"] - d["included"];
              excludedFullText.label.name =
                excludedFullText.label.name +
                "(n=" +
                noExcludedFullTextRecords +
                ")";
              // included
              included.label.name =
                included.label.name + "(n=" + d["included"] + ")";

              var readLinkNrStudies =
                "https://raw.githubusercontent.com/metapsy-project/" +
                repoName +
                "/" +
                repoVersion +
                "/metadata/" +
                "number_studies" +
                ".txt";
              fetch(readLinkNrStudies)
                .then((nrStudies) => nrStudies.text())
                .then((nrStudies) => {
                  // included in dataset
                  includedDataset.label.name =
                    includedDataset.label.name +
                    "(n=" +
                    String(JSON.parse(nrStudies)) +
                    ")";
                  // render flowchart
                  var flowcharty = new Flowcharty.default();
                  flowcharty.render(d3.select("#flow-svg"), dataFlowChart);
                });

              // set random ID
              document.getElementById('spinner-ph-flowchart').style.display = 'none';
              var div = document.getElementById("ph-flowchart");
              div.id = div.id + "-" + randID;

              // write exlcuded reasons section
              var reasonsExcludedJSON = d["full.text.excluded.reasons"];
              var keys = Object.keys(reasonsExcludedJSON);
              var html =
                " <div " +
                "style='background-color: var(--body-color);" +
                " padding: 20px 20px 0px 20px;" +
                "height:auto;'><ul " +
                "style='font-size: 90% !important;'>";
              for (let j = 0; j < keys.length; j++) {
                var addHtml =
                  "<li><strong>" +
                  String(keys[j]) +
                  ":</strong> <i>n</i>=" +
                  String(reasonsExcludedJSON[keys[j]]) +
                  "</li>";
                html = html + addHtml;
              }
              html = html + "</ul></div>";
              document.getElementById('spinner-ph-excluded-reasons').style.display = 'none';
              var div = document.getElementById("ph-excluded-reasons");
              div.id = "ph-excluded-reasons" + randID;
              div.innerHTML = html;
            });
          firstItem = false;
        }
      }
    }
  }
</script>
