<span id="ph-flowchart">
  <span id="spinner-ph-flowchart" class="loader-spinner"></span>
  <style>
  #spinner-ph-flowchart { width: 20px; height: 20px; margin-bottom: 10px; border: 2px solid rgb(133, 133, 133);
      border-bottom-color: transparent; border-radius: 50%; display: inline-block;
      box-sizing: border-box; animation: rotation 1s linear infinite;}
      @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}} 
  </style>
  <div id="flowchart-div">
    <center>
      <svg
        id="flow-svg"
        width="500"
        height="400"
        viewBox="0 0 500 400"
        style="max-width: 100%; max-height: 100%"
      ></svg>
    </center>
  </div>
</span>

<span id="flowchart-excluded-reasons-box">
  <button
    type="button"
    class="btn btn-default dropdown-toggle expand-btn"
    data-toggle="collapse"
    href="#collapseFlowchartExcludedReasons"
    role="button"
    aria-expanded="false"
  >
    Reasons for full-text exclusion<span class="caret"></span>
  </button>
  <div class="collapse" id="collapseFlowchartExcludedReasons">
    <div class="card card-body">
      <span id="ph-excluded-reasons"></span>
      <span id="spinner-ph-excluded-reasons" class="loader-spinner"></span>
      <style>
      #spinner-ph-excluded-reasons { width: 20px; height: 20px; margin-bottom: 10px; border: 2px solid rgb(133, 133, 133);
          border-bottom-color: transparent; border-radius: 50%; display: inline-block;
          box-sizing: border-box; animation: rotation 1s linear infinite;}
          @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}} 
      </style>
    </div>
  </div>
  <br />
</span>

<script defer>
var randID = makeid(10);

var dataFlowChart = {
  nodes: [
    {id: "database-search", label: {name: "Records identified through database searches \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 240, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "gray"}},
    {id: "other-sources", label: {name: "Records identified through other sources \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 220, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "gray"}},
    {id: "duplicate", label: {name: "Records after duplicate removal \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 190, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "gray"}},
    {id: "screen", label: {name: "Records screened \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 150, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "gray"}},
    {id: "records-excluded", label: {name: "Records excluded \n ", color: "black", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 150, height: 40, rx: 3, ry: 3, fillColor: "white", strokeColor: "gray"}},
    {id: "full-text", label: {name: "Full-text articles assessed for eligibility \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 210, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "#0372b7"}},
    {id: "included", label: {name: "Studies included in database \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 180, height: 40, rx: 3, ry: 3, fillColor: "#0372b7", strokeColor: "gray"}},
    {id: "excluded-full-text", label: {name: "Full-text excluded \n ", color: "black", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 150, height: 40, rx: 3, ry: 3, fillColor: "white", strokeColor: "gray"}},
    {id: "included-dataset", label: {name: "Studies included in dataset \n ", color: "white", dx: 0, dy: 5, textAnchor: "middle", fontFamily: "sans-serif", fontSize: "10px"}, style: {shape: "rect", width: 180, height: 40, rx: 3, ry: 3, fillColor: "#636363", strokeColor: "gray"}}
  ],
  map: [
    ["database-search", "other-sources"],
    ["duplicate", "drawIo"],
    ["screen", "records-excluded"],
    ["full-text", "excluded-full-text"],
    ["included"],
    ["included-dataset"]
  ],
  links: [
    {source: "database-search", target: "duplicate", style: {color: "gray"}},
    {source: "other-sources", target: "duplicate", style: {color: "gray"}},
    {source: "duplicate", target: "screen", style: {color: "gray"}},
    {source: "screen", target: "records-excluded", style: {color: "gray"}},
    {source: "screen", target: "full-text", style: {color: "gray"}},
    {source: "full-text", target: "included", style: {color: "gray"}},
    {source: "full-text", target: "excluded-full-text", style: {color: "gray"}},
    {source: "included", target: "included-dataset", style: {color: "gray"}}
  ]
};

async function renderFlowchart() {
  // Wait for data to be loaded
  while (!isDataSaved()) {
    await new Promise(resolve => setTimeout(resolve, 1000));
  }

  const conceptDOI = "{{.Get `doi`}}";
  
  try {
    // Fetch both files from JSON or ZIP
    const [searchFlowContent, numberStudiesContent] = await Promise.all([
      getMetadataFile(conceptDOI, "metadata/search_flow.json"),
      getMetadataFile(conceptDOI, "metadata/number_studies.txt")
    ]);
    
    // Parse if needed (already parsed if from JSON)
    const searchFlow = typeof searchFlowContent === 'object' ? searchFlowContent : JSON.parse(searchFlowContent);
    const numberStudies = typeof numberStudiesContent === 'number' ? numberStudiesContent : JSON.parse(numberStudiesContent);
    
    // Update flowchart nodes with data
    const databaseSearchNode = dataFlowChart.nodes.find(n => n.id === "database-search");
    const otherSourcesNode = dataFlowChart.nodes.find(n => n.id === "other-sources");
    const duplicateNode = dataFlowChart.nodes.find(n => n.id === "duplicate");
    const screenNode = dataFlowChart.nodes.find(n => n.id === "screen");
    const recordsExcludedNode = dataFlowChart.nodes.find(n => n.id === "records-excluded");
    const fullTextNode = dataFlowChart.nodes.find(n => n.id === "full-text");
    const excludedFullTextNode = dataFlowChart.nodes.find(n => n.id === "excluded-full-text");
    const includedNode = dataFlowChart.nodes.find(n => n.id === "included");
    const includedDatasetNode = dataFlowChart.nodes.find(n => n.id === "included-dataset");
    
    databaseSearchNode.label.name = databaseSearchNode.label.name + "(n=" + searchFlow["database.hits"] + ")";
    otherSourcesNode.label.name = otherSourcesNode.label.name + "(n=" + searchFlow["additional.records"] + ")";
    duplicateNode.label.name = duplicateNode.label.name + "(n=" + searchFlow["database.hits.duplicates.removed"] + ")";
    screenNode.label.name = screenNode.label.name + "(n=" + searchFlow["records.screened"] + ")";
    
    const noExcludedRecords = searchFlow["records.screened"] - searchFlow["full.text.assessed.for.eligibility"];
    recordsExcludedNode.label.name = recordsExcludedNode.label.name + "(n=" + noExcludedRecords + ")";
    
    fullTextNode.label.name = fullTextNode.label.name + "(n=" + searchFlow["full.text.assessed.for.eligibility"] + ")";
    
    const noExcludedFullTextRecords = searchFlow["full.text.assessed.for.eligibility"] - searchFlow.included;
    excludedFullTextNode.label.name = excludedFullTextNode.label.name + "(n=" + noExcludedFullTextRecords + ")";
    
    includedNode.label.name = includedNode.label.name + "(n=" + searchFlow.included + ")";
    includedDatasetNode.label.name = includedDatasetNode.label.name + "(n=" + String(numberStudies) + ")";
    
    // Render flowchart
    new Flowcharty.default().render(d3.select("#flow-svg"), dataFlowChart);
    
    // Hide spinner
    document.getElementById("spinner-ph-flowchart").style.display = "none";
    
    // Update excluded reasons
    const excludedReasons = searchFlow["full.text.excluded.reasons"];
    const reasonKeys = Object.keys(excludedReasons);
    let html = " <div style='background-color: var(--body-color); padding: 20px 20px 0px 20px;height:auto;'><ul style='font-size: 90% !important;'>";
    for (let i = 0; i < reasonKeys.length; i++) {
      html += "<li><strong>" + String(reasonKeys[i]) + ":</strong> <i>n</i>=" + String(excludedReasons[reasonKeys[i]]) + "</li>";
    }
    html += "</ul></div>";
    
    document.getElementById("spinner-ph-excluded-reasons").style.display = "none";
    const excludedReasonsDiv = document.getElementById("ph-excluded-reasons");
    excludedReasonsDiv.id = "ph-excluded-reasons" + randID;
    excludedReasonsDiv.innerHTML = html;
    
    // Update flowchart div ID
    const flowchartDiv = document.getElementById("ph-flowchart");
    flowchartDiv.id = flowchartDiv.id + "-" + randID;
  } catch (error) {
    console.error("Error loading flowchart:", error);
    document.getElementById("spinner-ph-flowchart").style.display = "none";
    document.getElementById("spinner-ph-excluded-reasons").style.display = "none";
    const flowchartDiv = document.getElementById("ph-flowchart");
    flowchartDiv.id = flowchartDiv.id + "-" + randID;
    flowchartDiv.innerHTML = "<em>Error loading flowchart</em>";
    const excludedReasonsDiv = document.getElementById("ph-excluded-reasons");
    excludedReasonsDiv.id = "ph-excluded-reasons" + randID;
    excludedReasonsDiv.innerHTML = "<em>Error loading excluded reasons</em>";
  }
}

renderFlowchart();
</script>
