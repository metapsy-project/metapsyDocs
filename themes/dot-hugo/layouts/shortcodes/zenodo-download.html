<button
  type="button"
  class="btn btn-default dropdown-toggle download-btn"
  data-toggle="dropdown"
>
  <i class="ti-download"></i>&nbsp;&nbsp;Download .ZIP
  <span class="caret"></span>
</button>
<ul class="dropdown-menu scrollable-menu" role="menu" id="ph-download">
  <span id="spinner-ph-doi2" class="loader-spinner"></span>
</ul>

<style>
  .loader-spinner { width: 20px; height: 20px; margin-left: 5px; margin-bottom: -5px; border: 2px solid rgb(133, 133, 133);
      border-bottom-color: transparent; border-radius: 50%; display: inline-block;
      box-sizing: border-box; animation: rotation 1s linear infinite;}
      @keyframes rotation {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}} 
  </style>

<script>
(function() {
  // Ensure makeid function is available
  if (typeof makeid === 'undefined') {
    window.makeid = function(length) {
      var result = "";
      var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    };
  }

  // Ensure isDataSaved function is available
  if (typeof isDataSaved === 'undefined') {
    window.isDataSaved = function() {
      return sessionStorage.getItem("dataSaved") === "true";
    };
  }

  var randID = makeid(10);

// Download ZIP file from Zenodo - make it globally accessible
window.downloadData = function(version) {
  // Wait for data to be loaded
  if (!isDataSaved()) {
    setTimeout(function() { downloadData(version); }, 1000);
    return;
  }

  var post = JSON.parse(sessionStorage.getItem("apiResponse"));
  var found = false;

  for (var i = 0; i < post.length; i++) {
    var searchDOI = post[i].conceptdoi ? post[i].conceptdoi.toString() : "";
    searchDOI = JSON.stringify(searchDOI);
    var inputDOI = JSON.stringify("{{.Get `doi`}}");

    if (searchDOI === inputDOI && post[i].metadata.version === version) {
      found = true;
      
      // Get the record ID and file info
      var recordId = post[i].id || post[i].record_id;
      var files = post[i].files || [];
      
      if (files.length > 0) {
        // Use the filename from the files array
        var filename = files[0].filename || files[0].key;
        
        // Construct the public API download URL
        // Format: https://zenodo.org/api/records/{record_id}/files/{filename}/content
        var downloadUrl = "https://zenodo.org/api/records/" + recordId + "/files/" + encodeURIComponent(filename) + "/content";
        
        // Create a temporary link and trigger download
        var link = document.createElement("a");
        link.href = downloadUrl;
        link.download = filename;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      break;
    }
  }
  
  if (!found) {
    console.error("Version not found or no files available");
  }
};

// Render download menu
function renderDownload() {
  // Wait for data to be saved
  function waitForData() {
    if (!isDataSaved()) {
      setTimeout(waitForData, 1000);
      return;
    }
    renderDownloadMenu();
  }
  
  function renderDownloadMenu() {
    var post = JSON.parse(sessionStorage.getItem("apiResponse"));
    var html = "";
    var isFirst = true;

    for (var i = 0; i < post.length; i++) {
      var searchDOI = post[i].conceptdoi ? post[i].conceptdoi.toString() : "";
      searchDOI = JSON.stringify(searchDOI);
      var inputDOI = JSON.stringify("{{.Get `doi`}}");

      if (searchDOI === inputDOI) {
        var months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
        ];
        var d = new Date(post[i].created);
        var month = months[d.getMonth()];
        var year = d.getFullYear();
        var day = d.getDate();
        var modDate = month + " " + day + ", " + year;

        if (isFirst) {
          html += "<li><a onclick=\"downloadData('" + post[i].metadata.version + "')\"><strong> Version " + post[i].metadata.version + "</strong> (" + modDate + "; latest)</a></li>";
          isFirst = false;
        } else {
          html += "<li><a onclick=\"downloadData('" + post[i].metadata.version + "')\"><strong> Version " + post[i].metadata.version + "</strong> (" + modDate + ")</a></li>";
        }
      }
    }

    var div = document.getElementById("ph-download");
    div.id = randID;
    div.innerHTML = html;
  }
  
  waitForData();
}

  renderDownload();
})();
</script>
