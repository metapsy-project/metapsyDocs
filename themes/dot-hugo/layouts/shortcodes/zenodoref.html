<span id="placeholder"></span>
<style>
/* Modal styles for search string */
.search-string-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.search-string-modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 800px;
  border-radius: 0;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.search-string-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 0;
  border-bottom: none;
}

.search-string-modal-header-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.search-string-modal-header h4 {
  margin: 0;
  font-size: 1.2em;
}

.search-string-close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 20px;
}

.search-string-close:hover,
.search-string-close:focus {
  color: #000;
}


.search-string-textarea {
  width: 100%;
  min-height: 300px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 0;
  font-family: monospace;
  font-size: 0.75em;
  resize: vertical;
  box-sizing: border-box;
}

.search-string-copy-btn {
  margin-right: 0;
  font-size: 12px;
  font-family: var(--font-family), sans-serif;
  text-transform: uppercase;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 0;
  font-weight: 600;
  border: 0;
  transition: .2s ease;
  background-color: var(--bs-primary);
  color: var(--body-color);
  cursor: pointer;
}

.search-string-copy-btn:hover {
  background-color: var(--bs-primary);
  color: var(--body-color);
}

.search-string-copy-btn.copied:hover {
  background-color: #28a745 !important;
  color: var(--body-color) !important;
}

.search-string-copy-btn.copied:active,
.search-string-copy-btn.copied:focus {
  background-color: #28a745 !important;
  color: var(--body-color) !important;
}

.search-string-copy-btn:focus {
  outline: 0;
  box-shadow: none !important;
}

.search-string-copy-btn.copied {
  background-color: #28a745;
  color: var(--body-color);
}
</style>
<script>
  // random id generator
  function makeid(length) {
    var result = "";
    var characters =
      "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
  }
  var randID = makeid(10);
  var modalId = 'search-string-modal-' + randID;
  
  // Function to open search string modal
  function openSearchStringModal(content) {
    // Create modal if it doesn't exist
    let modal = document.getElementById(modalId);
    if (!modal) {
      modal = document.createElement("div");
      modal.id = modalId;
      modal.className = "search-string-modal";
      
      const modalContent = document.createElement("div");
      modalContent.className = "search-string-modal-content";
      
      const header = document.createElement("div");
      header.className = "search-string-modal-header";
      
      const headerLeft = document.createElement("div");
      headerLeft.className = "search-string-modal-header-left";
      
      const copyBtn = document.createElement("button");
      copyBtn.className = "search-string-copy-btn btn btn-default";
      const copyIcon = document.createElement("i");
      copyIcon.className = "bi bi-clipboard";
      copyBtn.appendChild(copyIcon);
      
      const h4 = document.createElement("h4");
      h4.textContent = "Search String";
      
      const closeSpan = document.createElement("span");
      closeSpan.className = "search-string-close";
      closeSpan.innerHTML = "&times;";
      
      const textarea = document.createElement("textarea");
      textarea.className = "search-string-textarea";
      textarea.readOnly = true;
      textarea.value = content;
      
      copyBtn.onclick = function() {
        textarea.select();
        document.execCommand('copy');
        copyIcon.className = "bi bi-check";
        copyBtn.classList.add("copied");
        setTimeout(function() {
          copyIcon.className = "bi bi-clipboard";
          copyBtn.classList.remove("copied");
        }, 2000);
      };
      
      headerLeft.appendChild(copyBtn);
      headerLeft.appendChild(h4);
      header.appendChild(headerLeft);
      header.appendChild(closeSpan);
      
      const textareaWrapper = document.createElement("div");
      textareaWrapper.className = "search-string-textarea-wrapper";
      textareaWrapper.appendChild(textarea);
      
      modalContent.appendChild(header);
      modalContent.appendChild(textareaWrapper);
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Close modal when clicking X or outside
      closeSpan.onclick = function() {
        modal.style.display = "none";
      };
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };
    } else {
      // Update content if modal exists
      const textarea = modal.querySelector(".search-string-textarea");
      if (textarea) {
        textarea.value = content;
      }
      // Reset button state
      const copyBtn = modal.querySelector(".search-string-copy-btn");
      if (copyBtn) {
        const icon = copyBtn.querySelector("i");
        if (icon) {
          icon.className = "bi bi-clipboard";
        }
        copyBtn.classList.remove("copied");
      }
    }
    
    modal.style.display = "block";
  }

  if ("{{.Get `type`}}" === "all-versions") {
    // Wait for data to be loaded, then use static zenodo.json
    async function renderAllVersions() {
      while (!isDataSaved()) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      const post = JSON.parse(sessionStorage.getItem("apiResponse"));
        // start div
        var html =
          "<button class='accbutton' style='border: none;" +
          " font-size: 80%; margin-bottom: 0px; cursor: auto;'> " +
          "Browse all versions</button> <div " +
          "style='background-color: var(--body-color);" +
          " padding: 20px 20px 20px 20px;" +
          "overflow-y: scroll; height:150px;'><ul " +
          "style='font-size: 90% !important;'>";

        // loop through all elements
        for (let i = 0; i < post.length; i++) {
          var searchDOI = post[i].conceptdoi?.toString() || "";
          searchDOI = JSON.stringify(searchDOI);
          var inputDOI = JSON.stringify("{{.Get `doi`}}");

          if (searchDOI === inputDOI) {
            // get last modified date
            const months = [
              "January",
              "February",
              "March",
              "April",
              "May",
              "June",
              "July",
              "August",
              "September",
              "October",
              "November",
              "December",
            ];
            const d = new Date(post[i].modified);
            const month = months[d.getMonth()];
            const year = d.getFullYear();
            const day = d.getDate();
            modDate = month + " " + day + ", " + year;

            // get zenodo DOI badge
            var badgeUrl = post[i].links.conceptbadge;
            var href = post[i].links.doi;
            var insertText =
              "<li><strong> Version " +
              post[i].metadata.version +
              "</strong> (" +
              String(modDate) +
              "): " +
              "<a target='_blank' href='" +
              href +
              "'><img src='" +
              badgeUrl +
              "' style='padding: 0px; margin: 0px; display: inline;'></a></li>";

            html = html + insertText;
          }
        }
        html = html + "</ul></div>";
        var div = document.getElementById("placeholder");
        div.id = randID;
        div.innerHTML = html;
    }
    
    renderAllVersions();
  } else {
    // Wait for data to be loaded, then use static zenodo.json
    async function renderZenodoRef() {
      while (!isDataSaved()) {
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      const post = JSON.parse(sessionStorage.getItem("apiResponse"));
        // loop through all elements
        for (let i = 0; i < post.length; i++) {
          var searchDOI = post[i].conceptdoi?.toString() || "";
          searchDOI = JSON.stringify(searchDOI);
          var inputDOI = JSON.stringify("{{.Get `doi`}}");

          if (searchDOI === inputDOI) {
            if ("{{.Get `type`}}" === "github-release") {
              var link = document.createElement("a");
              var href = post[i].metadata.related_identifiers[0].identifier;
              link.innerText = "{{.Get `text`}}";
              link.setAttribute("href", href);
              link.setAttribute("target", "blank");
              link.setAttribute("style", "color: unset !important");
              var div = document.getElementById("placeholder");
              div.id = randID;
              div.appendChild(link);
            }
            if ("{{.Get `type`}}" === "last-updated") {
              const months = [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
              ];
              const d = new Date(post[i].modified);
              const month = months[d.getMonth()];
              const year = d.getFullYear();
              const day = d.getDate();
              modDate = document.createTextNode(
                month + " " + day + ", " + year
              );
              var div = document.getElementById("placeholder");
              div.id = randID;
              div.appendChild(modDate);
            }
            if ("{{.Get `type`}}" === "last-updated-year") {
              const d = new Date(post[i].modified);
              const year = d.getFullYear();
              modDate = document.createTextNode("(" + year + ")");
              var div = document.getElementById("placeholder");
              div.id = randID;
              div.appendChild(modDate);
            }
            if ("{{.Get `type`}}" === "version") {
              const version = post[i].metadata.version;
              latestVersion = document.createTextNode(version);
              var div = document.getElementById("placeholder");
              div.id = randID;
              div.appendChild(latestVersion);
            }
            if ("{{.Get `type`}}" === "doi") {
              const version = post[i].links.conceptdoi;
              latestVersion = document.createTextNode(version);
              var div = document.getElementById("placeholder");
              div.id = randID;
              div.appendChild(latestVersion);
            }
            if ("{{.Get `type`}}" === "badge") {
              var badgeUrl = post[i].links.conceptbadge;
              var href = post[i].links.conceptdoi;
              var img = document.createElement("img");
              var link = document.createElement("a");
              link.setAttribute("href", href);
              link.setAttribute("target", "blank");
              img.setAttribute("src", badgeUrl);
              var div = document.getElementById("placeholder");
              div.id = randID;
              img.style.maxWidth = "unset !important";
              img.style.height = "unset !important";
              img.style.padding = 0;
              img.style.margin = 0;
              img.style.display = "inline";
              link.appendChild(img);
              div.appendChild(link);
            }
            if ("{{.Get `type`}}" === "authors") {
              const conceptDOI = post[i].conceptdoi;
              getMetadataFile(conceptDOI, "metadata/authors.txt")
                .then((d) => {
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = d;
                })
                .catch((error) => {
                  console.error("Error loading authors:", error);
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<em>Error loading authors</em>";
                });
            }
            if ("{{.Get `type`}}" === "search-string") {
              const conceptDOI = post[i].conceptdoi;
              getMetadataFile(conceptDOI, "metadata/search_string.txt")
                .then((d) => {
                  const links = document.createElement("a");
                  links.innerText = "{{.Get `text`}}";
                  links.setAttribute("href", "#");
                  links.setAttribute("style", "color: unset !important; cursor: pointer; text-decoration: none;");
                  links.onclick = function(e) {
                    e.preventDefault();
                    openSearchStringModal(d);
                  };
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.appendChild(links);
                })
                .catch((error) => {
                  console.error("Error loading search string:", error);
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<em>Error loading search string</em>";
                });
            }
            if ("{{.Get `type`}}" === "last-search") {
              const conceptDOI = post[i].conceptdoi;
              getMetadataFile(conceptDOI, "metadata/last_search.txt")
                .then((d) => {
                  const months = [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December",
                  ];
                  let dateStr = new String(d);
                  if (dateStr.length > 10) {
                    dateStr = dateStr.substring(0, 10);
                  }
                  const date = new Date(dateStr);
                  const month = months[date.getMonth()];
                  const year = date.getFullYear();
                  const day = date.getDate();
                  modDate = document.createTextNode(
                    month + " " + day + ", " + year
                  );
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.appendChild(modDate);
                })
                .catch((error) => {
                  console.error("Error loading last search:", error);
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<em>Error loading last search date</em>";
                });
            }
            if ("{{.Get `type`}}" === "shorthand") {
              const conceptDOI = post[i].conceptdoi;
              getMetadataFile(conceptDOI, "metadata/shorthand.txt")
                .then((d) => {
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<code>" + d + "</code>";
                })
                .catch((error) => {
                  console.error("Error loading shorthand:", error);
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<em>Error loading shorthand</em>";
                });
            }
            if ("{{.Get `type`}}" === "variable-description") {
              const conceptDOI = post[i].conceptdoi;
              getMetadataFile(conceptDOI, "metadata/variable_description.json")
                .then((d) => {
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  // If it's already parsed (from JSON), use it; otherwise parse it
                  tableData = typeof d === 'object' ? d : JSON.parse(d);
                  // extract variable names & definitions
                  var keys = Object.keys(tableData);
                  var values = Object.values(tableData);
                  // start constructing table
                  var table = document.createElement("table");
                  var tr = table.insertRow(-1);
                  // table header
                  var th1 = document.createElement("th");
                  th1.innerHTML = "Variable";
                  var th2 = document.createElement("th");
                  th2.innerHTML = "Description";
                  tr.appendChild(th1);
                  tr.appendChild(th2);
                  // add contents via loop
                  for (var j = 0; j < keys.length; j++) {
                    tr = table.insertRow(-1);
                    var tabCell1 = tr.insertCell(-1);
                    tabCell1.innerHTML = "<code>" + keys[j] + "</code>";
                    var tabCell2 = tr.insertCell(-1);
                    tabCell2.innerHTML = values[j];
                  }
                  table.style.fontSize = "90%";
                  div.appendChild(table);
                })
                .catch((error) => {
                  console.error("Error loading variable description:", error);
                  var div = document.getElementById("placeholder");
                  div.id = randID;
                  div.innerHTML = "<em>Error loading variable description</em>";
                });
            }
          }
        }
      }
      
      renderZenodoRef();
  }
</script>
